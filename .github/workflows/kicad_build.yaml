name: Generate KiCad artifacts

on:
  push:
    branches:
      - main

    # This is needed, otherwise commiting fresh artifacts will trigger this job again
    paths-ignore:
      - "static/**"

env:
  STATIC_DIR: "static"

jobs:
  build:
    name: Generate KiCad artifacts
    runs-on: ubuntu-latest
    permissions: # Needed for PR creation
      contents: write
      pull-requests: write
    container:
      image: "kicad/kicad:9.0"
      options: --user root
    steps:
      - uses: actions/checkout@v4

      - name: Fix Git repo ownership
        run: |
          # this is to fix GIT not liking owner of the checkout dir
          chown -R $(id -u):$(id -g) $PWD

      - name: Install dependencies
        run: |
          apt update && apt install make -y

      - name: Link KiCad .config dir to root equivalent
        run: |
          mkdir -p ~/.config
          ln -s /home/kicad/.config/kicad ~/.config/kicad

      - name: Ensure output dir exists
        run: mkdir -p ${{ env.STATIC_DIR }}

      - name: Generate artifacts
        run: |
          make artifacts STATIC_DIR=${{ env.STATIC_DIR }}

      - name: Check diff for create date changes
        run: |
          if [ -z $(git diff --ignore-matching-lines='\/CreationDate \(D:' --ignore-matching-lines='<title>SVG Image created as .+.svg date') ]; then
            echo "No relevant changes detected. Cleaning repo state."
            git clean -fdx
          else
            echo "Detected relevant artifact changes"
          fi

      - name: Create pull request
        uses: peter-evans/create-pull-request@v7
        with:
          branch: update-kicad-artifacts
          commit-message: Update dependencies
          title: Update dependencies
          body: |
            ## Beep boop, fresh artifacts ü§ñ. 

            KiCad project sources have changed, fresh artifacts incoming ‚ôªÔ∏è!

            Auto-generated by [create-pull-request][1]

            [1]: https://github.com/peter-evans/create-pull-request
